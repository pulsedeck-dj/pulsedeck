<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PulseDeck Party Requests</title>
    <meta name="theme-color" content="#00b9ff" />
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Grotesk:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="shape shape-a" aria-hidden="true"></div>
    <div class="shape shape-b" aria-hidden="true"></div>
    <div class="shape shape-c" aria-hidden="true"></div>

    <main class="shell">
      <header class="hero reveal">
        <p class="eyebrow">PulseDeck Official Request System</p>
        <h1>Simple For Guests. Solid For DJs.</h1>
        <p class="subtitle">
          Secure DJ login, one-tap party creation, and a clean song request flow with Apple Music search.
        </p>

        <div class="hero-meta">
          <p id="backendStatus" class="status status-info" aria-live="polite">Checking backend connection...</p>
          <button id="openSetupBtn" class="btn btn-ghost" type="button">Connection Settings</button>
        </div>

        <div class="flow-strip" aria-label="How it works">
          <span>DJ signs in</span>
          <span>Party created</span>
          <span>DJ app claims code</span>
          <span>Guests request songs</span>
        </div>
      </header>

      <nav class="window-tabs reveal delay-1" aria-label="App windows">
        <button id="tabGuest" class="window-tab is-active" type="button" data-window="guest">Guest Window</button>
        <button id="tabDj" class="window-tab" type="button" data-window="dj">DJ Window</button>
        <button id="tabSetup" class="window-tab" type="button" data-window="setup">Setup Window</button>
        <button id="tabStatus" class="window-tab" type="button" data-window="status">Status Window</button>
        <button id="tabHelp" class="window-tab" type="button" data-window="help">Help Window</button>
      </nav>

      <section id="guestWindow" class="window-panel reveal delay-2" data-window="guest">
        <article class="panel" id="joinSection">
          <div class="panel-head">
            <h2>Join Party</h2>
            <span class="chip">Guest</span>
          </div>
          <p class="panel-copy">Enter the party code from the DJ screen.</p>

          <form id="joinForm" class="form-grid">
            <label for="partyCode">Party Code</label>
            <input id="partyCode" maxlength="6" autocomplete="off" required />
            <button type="submit" class="btn btn-secondary">Join Party</button>
          </form>
          <p id="joinResult" class="status status-neutral" aria-live="polite">Waiting for code.</p>
          <button id="stopCheckingBtn" class="btn btn-ghost btn-mini hidden" type="button">Stop Checking</button>
        </article>

        <article class="panel" id="guestSummaryPanel">
          <div class="panel-head">
            <h2>Guest Session</h2>
            <span class="chip">Now</span>
          </div>
          <div class="summary-grid">
            <div class="summary-item">
              <span>Connected Party</span>
              <strong id="guestPartyCodeOut">------</strong>
            </div>
            <div class="summary-item">
              <span>Requests Sent</span>
              <strong id="guestRequestCountOut">0</strong>
            </div>
          </div>
          <p id="guestLastRequestOut" class="micro-note">No requests sent yet.</p>
          <ul id="guestRecentRequests" class="recent-list" aria-label="Recent requests"></ul>
        </article>

        <article class="panel hidden" id="requestSection">
          <div class="panel-head">
            <h2>Send Song Request</h2>
            <span class="chip">Live Queue</span>
          </div>

          <form id="requestForm" class="form-grid">
            <p class="mini-label">Choose service</p>
            <div class="service-row" role="radiogroup" aria-label="Music service">
              <label class="service-pill">
                <input type="radio" name="service" value="Apple Music" checked />
                <span>Apple Music</span>
              </label>
              <label class="service-pill">
                <input type="radio" name="service" value="Spotify" />
                <span>Spotify</span>
              </label>
              <label class="service-pill">
                <input type="radio" name="service" value="YouTube" />
                <span>YouTube</span>
              </label>
            </div>

            <div id="appleSearchSection" class="apple-search">
              <label for="appleSearchTerm">Search Apple Music</label>
              <div class="search-row">
                <input id="appleSearchTerm" maxlength="120" placeholder="Search song or artist" />
                <button id="appleSearchBtn" class="btn btn-secondary" type="button">Search</button>
              </div>
              <p id="appleSearchStatus" class="status status-neutral">Search to autofill song info.</p>
              <div id="appleSearchResults" class="search-results"></div>
            </div>

            <label for="title">Song Title</label>
            <input id="title" maxlength="120" required />

            <label for="artist">Artist</label>
            <input id="artist" maxlength="120" required />

            <details class="advanced-link-block">
              <summary>Advanced: Paste Song Link (Optional)</summary>
              <label for="songUrl" class="advanced-label">Song URL</label>
              <input id="songUrl" maxlength="500" placeholder="https://music.apple.com/..." />
              <div class="link-tools">
                <button id="songUrlAutofillBtn" class="btn btn-ghost btn-mini" type="button">
                  Autofill From Link
                </button>
              </div>
              <p id="songUrlAutofillStatus" class="status status-neutral" aria-live="polite">
                Paste a link and tap Autofill to pull title + artist.
              </p>
            </details>

            <button type="submit" class="btn btn-primary">Submit Request</button>
          </form>

          <p id="requestResult" class="status status-neutral" aria-live="polite">No request submitted yet.</p>
        </article>
      </section>

      <section id="djWindow" class="window-panel hidden" data-window="dj">
        <div class="panel-grid panel-grid-2">
          <article class="panel" id="authSection">
            <div class="panel-head">
              <h2>DJ Account</h2>
              <span class="chip">Auth</span>
            </div>
            <p class="panel-copy">Register or log in before creating party codes.</p>

            <form id="authForm" class="form-grid">
              <label for="authEmail">Email</label>
              <input id="authEmail" type="email" autocomplete="email" required />

              <label for="authPassword">Password</label>
              <input id="authPassword" type="password" minlength="10" autocomplete="current-password" required />

              <div class="button-row">
                <button id="registerBtn" class="btn btn-secondary" type="button">Register</button>
                <button id="loginBtn" class="btn btn-primary" type="button">Login</button>
              </div>
            </form>

            <button id="logoutBtn" class="btn btn-ghost hidden" type="button">Logout</button>
            <p id="authResult" class="status status-neutral" aria-live="polite">Not signed in.</p>
            <p id="authIdentity" class="micro-note hidden"></p>
          </article>

          <article class="panel" id="createSection">
            <div class="panel-head">
              <h2>Party Control</h2>
              <span class="chip">Secure</span>
            </div>
            <p class="panel-copy">Create a room and private DJ key for your DJ desktop app.</p>
            <button id="createPartyBtn" class="btn btn-primary" disabled>Create Party</button>
            <p id="createResult" class="status status-neutral" aria-live="polite">Sign in to create parties.</p>

            <div id="djSecrets" class="secret-grid hidden" aria-live="polite">
              <div class="secret-card">
                <span>Party Code</span>
                <strong id="partyCodeOut">------</strong>
                <button id="copyPartyCodeBtn" class="btn btn-ghost" type="button">Copy Code</button>
              </div>
              <div class="secret-card">
                <span>DJ Key</span>
                <strong id="djKeyOut">----------</strong>
                <button id="copyDjKeyBtn" class="btn btn-ghost" type="button">Copy DJ Key</button>
              </div>
            </div>

            <div id="djSharePanel" class="share-mini hidden" aria-live="polite">
              <p class="mini-label">Guest Link</p>
              <p id="djGuestLinkOut" class="share-link"></p>
              <div class="button-row">
                <button id="copyGuestLinkBtn" class="btn btn-secondary" type="button">Copy Guest Link</button>
                <button id="openGuestWindowBtn" class="btn btn-ghost" type="button">Open Guest Window</button>
              </div>
            </div>

            <p class="micro-note">
              Share the party code publicly. Keep the DJ key private and only enter it in PulseDeck DJ desktop.
            </p>
          </article>
        </div>
      </section>

      <section id="setupWindow" class="window-panel hidden" data-window="setup">
        <div class="panel-grid panel-grid-2">
          <article class="panel">
            <div class="panel-head">
              <h2>Backend Connection</h2>
              <div class="panel-head-actions">
                <button id="setupBackBtn" class="btn btn-ghost btn-mini" type="button">Back</button>
                <span class="chip">Required</span>
              </div>
            </div>
            <p class="panel-copy">
              Set your API base URL once. This makes the live site work even if default config is empty.
            </p>

            <form id="apiBaseConfigForm" class="form-grid">
              <label for="apiBaseConfig">API Base URL</label>
              <input id="apiBaseConfig" placeholder="https://your-api.example.com" />

              <div class="button-row button-row-3">
                <button id="saveApiBaseBtn" class="btn btn-primary" type="submit">Save</button>
                <button id="testApiBaseBtn" class="btn btn-secondary" type="button">Test</button>
                <button id="clearApiBaseBtn" class="btn btn-ghost" type="button">Clear</button>
              </div>
            </form>

            <p id="apiBaseConfigStatus" class="status status-neutral" aria-live="polite">No saved API base URL yet.</p>
            <p class="micro-note">Current effective API base: <span id="effectiveApiBase">Not configured</span></p>
          </article>

          <article class="panel">
            <div class="panel-head">
              <h2>Operator Guide</h2>
              <span class="chip">Quick Start</span>
            </div>
            <ol class="guide-list">
              <li>Open DJ Window, sign in, and create a party.</li>
              <li>Open PulseDeck DJ desktop and enter API Base URL, Party Code, and DJ Key.</li>
              <li>Click Connect in the DJ desktop app.</li>
              <li>Guests open Guest Window and enter the code to submit songs.</li>
            </ol>
            <p class="micro-note">
              Tip: The DJ app can generate a QR code that opens this page with the party code already filled in.
            </p>
          </article>
        </div>
      </section>

      <section id="statusWindow" class="window-panel hidden" data-window="status">
        <div class="panel-grid panel-grid-2">
          <article class="panel">
            <div class="panel-head">
              <h2>System Status</h2>
              <span class="chip">Live</span>
            </div>

            <div class="status-card-grid">
              <article class="status-card">
                <p>Backend</p>
                <strong id="sysBackendValue">Checking...</strong>
              </article>
              <article class="status-card">
                <p>DJ Account</p>
                <strong id="sysAuthValue">Signed out</strong>
              </article>
              <article class="status-card">
                <p>Latest Party</p>
                <strong id="sysPartyValue">------</strong>
              </article>
              <article class="status-card">
                <p>Guest Join</p>
                <strong id="sysGuestValue">Not joined</strong>
              </article>
            </div>
          </article>

          <article class="panel">
            <div class="panel-head">
              <h2>Event Timeline</h2>
              <button id="clearTimelineBtn" class="btn btn-ghost" type="button">Clear</button>
            </div>
            <div id="eventTimeline" class="timeline-list"></div>
          </article>
        </div>
      </section>

      <section id="helpWindow" class="window-panel hidden" data-window="help">
        <div class="panel-grid panel-grid-2">
          <article class="panel">
            <div class="panel-head">
              <h2>Download DJ App</h2>
              <span class="chip">macOS</span>
            </div>
            <p class="panel-copy">
              PulseDeck DJ is a downloadable macOS desktop app. Install it to claim the DJ role and receive requests in
              realtime.
            </p>
            <a
              class="btn btn-primary"
              href="https://github.com/pulsedeck-dj/pulsedeck/releases"
              target="_blank"
              rel="noreferrer noopener"
            >
              Open Releases
            </a>
            <p class="micro-note">Tip: Always download the latest `.dmg` from Releases.</p>
          </article>

          <article class="panel">
            <div class="panel-head">
              <h2>Troubleshooting</h2>
              <span class="chip">Fix</span>
            </div>
            <ul class="help-list">
              <li><strong>Backend not configured:</strong> open Setup Window and set your API Base URL.</li>
              <li><strong>DJ not active:</strong> the DJ must open the DJ app and click Connect for that party code.</li>
              <li><strong>Apple Music search unavailable:</strong> backend cannot reach Apple right now. Optional: add an Apple developer token for full catalog search.</li>
              <li><strong>Keep DJ key private:</strong> only paste it into PulseDeck DJ desktop.</li>
            </ul>
          </article>
        </div>
      </section>
    </main>

    <script src="vendor/supabase.js"></script>
    <script src="config.js"></script>
    <script src="script.js"></script>
  </body>
</html>
